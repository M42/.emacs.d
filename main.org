#+Title: Cosmoi Emacs
#+Author: Mario Román
#+Email: mromang08@gmail.com
#+TODO: WIP | DONE

* Emacs
This is my *Emacs* init file, written in org-mode using literate programming and =org-babel= blocks. The =init.el= file tangles the Elisp code blocks of this file into =config.el=. 

I have taken ideas for my configuration from many sources, and I am really grateful to all of them.

  * [[http://cestlaz.github.io/][C'est la Z]]
  * [[https://github.com/hrs/dotfiles/blob/master/emacs.d/configuration.org][Harry R. Schwartz's configuration file]]
  * [[http://emacsredux.com/][Emacs Redux]]
  * [[http://irreal.org/blog/][Irreal]]
  * [[https://oremacs.com][(or emacs irrelevant)]]
  * [[http://pages.sachachua.com/.emacs.d/Sacha.html][Sacha Chua's configuration file]]
  * [[http://karl-voit.at/2017/06/03/emacs-org/][Karl Voit's configuration file]]
  * [[http://spacemacs.org/][Spacemacs]]
  * [[https://github.com/alhassy/emacs.d][Musa Al-hassy's configuration file]]

It /works for me/ on Emacs 26.3 and org-version 9.3.6. You can check your Emacs version with =M-x version= and your org-mode version with =M-x org-version=.

* Basic
These are the declarations for the basic configuration variables.

 * [[https://www.gnu.org/software/emacs/manual/html_node/elisp/User-Identification.html][User identification - Emacs]]

#+BEGIN_SRC emacs-lisp
  ;; A message to know that it is loading.
  (message "[cosmoi-emacs]: Basic configuration")

  ;; User information is used by Emacs in frame titles and
  ;; email. 
  (setq user-full-name "Mario Román")
  (setq user-mail-address "mromang08@gmail.com")

  ;; A list of the most important files on my workflow. Those
  ;; variables are used all across the configuration file; and listing
  ;; them here eases the process of rewriting directory paths.
  (setq m42/math-file       (expand-file-name "~/org/Math.org"))
  (setq cosmoi/init-file    (expand-file-name "~/.emacs.d/main.org"))
  (setq m42/agenda-file     (expand-file-name "~/org/agenda/Tasks.org"))
  (setq m42/journal-file    (expand-file-name "~/org/Journal.org"))
  (setq m42/archive-file    (expand-file-name "~/org/Archive.org"))
  (setq m42/org-folder      (expand-file-name "~/org"))

  ;; Jumps to the important files with a single keystroke.
  (global-set-key (kbd "<f8>") 
    (lambda() (interactive) (find-file cosmoi/init-file)))
  
  ;; I prefer to use a separate custom file for Emacs. This means any
  ;; configurations that are created using the Customize menu and the
  ;; list of installed packages will be kept separate of this org
  ;; configuration.
  ;; http://emacsblog.org/2008/12/06/quick-tip-detaching-the-custom-file/
  (setq custom-file "~/.emacs.d/custom.el")
  (load custom-file 'noerror)

  ;; Inhibits the startup screen and loads an initial buffer.
  (setq inhibit-startup-screen t)
  (setq initial-buffer-choice m42/agenda-file)

  ;; Disables toolbar and menubar
  ;(tool-bar-mode -1)
  ;(menu-bar-mode -1)
  ;(scroll-bar-mode -1)
  (tooltip-mode -1)

  ;; Includes the local bin on the 'exec-path'. This allows Emacs to
  ;; find executables in the local binaries folder.
  (setq exec-path (cons "/home/mario/.local/bin" exec-path))

  ;; The configuration files can be reloaded at any time using
  ;; =M-insert=.  This eases the process of writing, debugging and
  ;; testing the configuration file. Current set variables will not be
  ;; removed; and Emacs will need a complete restart to clean them.
  (global-set-key [M-insert] 
     '(lambda() (interactive) (load-file "~/.emacs.d/init.el")))

  ;; Restart-emacs is a package to restart Emacs from within Emacs. It
  ;; offers the command =restart-emacs=, which kills the current Emacs
  ;; session and starts a new session.
  ;; https://github.com/iqbalansari/restart-emacs
  (use-package restart-emacs :ensure t)

  ;; Better defaults for Emacs.
  (use-package better-defaults :ensure t)

  ;; Disable warnings when opening large files.
  (setq large-file-warning-threshold nil)

  ;; Disables backup files.
  (setq make-backup-files nil)

  ;; The cursor should not blink
  (setq blink-cursor-mode nil)

  ;; Autorrevert packages automatically.
  (global-auto-revert-mode 1)

  ;; Yes-no questions are unnecessarily long.  It is preferable to
  ;; simply use y or n.
  (fset 'yes-or-no-p 'y-or-n-p)

  ;; Word-wrapping.
  (setq-default word-wrap 1)
  (delete-selection-mode 1)
#+END_SRC

We ask the operative system to change Caps to Ctrl. This is a possible solution to the [[http://ergoemacs.org/emacs/emacs_pinky.html][Emacs pinky]]. It becomes a systemwide option, but I prefer this to be systemwide anyway.

#+BEGIN_SRC emacs-lisp
(shell-command "setxkbmap -option ctrl:nocaps")
#+END_SRC

* Utilities
[[http://pragmaticemacs.com/emacs/multiple-cursors/][Multiple cursors]] is a way of dealing with several cursors that do the same actions in different points of the file.  You can duplicate the current cursor to the next line multiple times with =Ctrl->=.

#+BEGIN_SRC emacs-lisp
  ;; Edit with multiple cursors at the same time.
  (use-package multiple-cursors
    :ensure t
    :bind (("C-S-c C-S-c" . mc/edit-lines)
	   ("C->" . mc/mark-next-like-this)))

  ;; A better regexp search.
  (use-package visual-regexp
    :bind (
      ("C-c C-r" . vr/replace)
      ("C-c q" . vr/query-replace)
      ("C-c m" . vr/mc-mark)
      ))

  ;; Indicates what face are we using currently under the cursor.
  (defun what-face (pos)
    (interactive "d")
    (let ((face (or 
        (get-char-property (point) 'read-face-name)
	  (get-char-property (point) 'face))))
      (if face
        (message "Face: %s" face) 
        (message "No face at %d" pos))))

  ;; A better help
  (use-package helpful :ensure t)

  ;; Helps discoverability by showing you the available commands at
  ;; any time.
  (use-package which-key
    :ensure t
    :config 
      (which-key-mode)
      (setq which-key-idle-delay 0.4))

  ;; Smex provides an enhancement to the =M-x= command. Uses =ido= for
  ;; autocompletion and provides a convenient interface to the most
  ;; frequently used commands.
  ;; https://www.emacswiki.org/emacs/Smex
  (use-package smex
    :ensure t
    :config (smex-initialize)
    :bind (("M-x" . smex)))

  ;; Smartparens tries to be smart about parens.
  ;; https://github.com/Fuco1/smartparens
  (use-package smartparens :ensure t)

  ;; Electric parens.
  (electric-pair-mode 1)

  ;; Flycheck checks the syntax of programming languages.
  (use-package flycheck
    :ensure t
    :init (global-flycheck-mode))

  ;; Multiple modes at the same time with polymode.
  (use-package polymode :ensure t)

  ;; Magit is an interface to the version control system Git. The main
  ;; function is 'magit-status', which shows the status of the files on
  ;; the current repository. 
  ;;  https://magit.vc/
  ;;  https://git-scm.com/
  (use-package magit
    :ensure t
    :bind ("C-c g" . magit-status))

  ;; Magit-todo's.
  (use-package magit-todos
    :ensure t
    :config (magit-todos-mode))

  ;; Projectile manages projects and allows us to jump between files of
  ;; the same project.
  (use-package projectile
    :ensure t
    :config
      (projectile-global-mode)
      (setq projectile-completion-system 'ivy))

  ;; Unfill paragraph takes a paragraph separated by newlines into a
  ;; single line.
  (defun unfill-paragraph ()
    "Replace newline chars in current paragraph by single spaces.
  This command does the reverse of `fill-paragraph'."
    (interactive)
    (let ((fill-column 90002000))
      (fill-paragraph nil)))

  (defun unfill-region (start end)
    "Replace newline chars in region by single spaces.
  This command does the reverse of `fill-region'."
    (interactive "r")
    (let ((fill-column 90002000))
      (fill-region start end))) 
#+END_SRC

** Swiper and search
#+BEGIN_SRC emacs-lisp
  ;; Swiper provides a fast search method.
  (use-package counsel :ensure t)
  (use-package swiper
    :ensure t
    :config
    (progn
      (ivy-mode 1)
      (setq ivy-use-virtual-buffers t)
      (global-set-key (kbd "C-M-s") 'swiper)
      (global-set-key (kbd "C-c r") 'ivy-resume)
      (global-set-key (kbd "M-x") 'counsel-M-x)
      (global-set-key (kbd "C-x C-f") 'counsel-find-file)
      (global-set-key (kbd "<f1> f") 'counsel-describe-function)
      (global-set-key (kbd "<f1> v") 'counsel-describe-variable)
      (global-set-key (kbd "<f1> l") 'counsel-load-library)
      (global-set-key (kbd "<f2> i") 'counsel-info-lookup-symbol)
      (global-set-key (kbd "<f2> u") 'counsel-unicode-char)
      (global-set-key (kbd "C-c g") 'counsel-git)
      (global-set-key (kbd "C-c j") 'counsel-git-grep)
      (global-set-key (kbd "C-c k") 'counsel-ag)
      (global-set-key (kbd "C-x l") 'counsel-locate)
      (global-set-key (kbd "C-S-o") 'counsel-rhythmbox)
      (define-key read-expression-map (kbd "C-r")
      'counsel-expression-history)))

  ;; Anzu displays the current match and the total matches information
  ;; in the mode-line.
  (use-package anzu
    :ensure t
    :init
      (anzu-mode +1)
      (global-anzu-mode +1)
    :config
      (setq anzu-cons-mode-line-p nil))

  ;; Search should be case-insensitive.
  (setq case-fold-search t)
#+END_SRC
** COMMENT Pdf-tools
#+BEGIN_SRC emacs-lisp
  ;; Read pdfs inside Emacs.
  (use-package pdf-tools
    :pin manual
    :ensure t
    :config 
      (pdf-tools-install)
      ; Display the pdf in a complete page.
      (setq-default pdf-view-display-size 'fit-page)
      ; Fine-grained zooming with + and -
      (setq pdf-view-resize-factor 1.1)
      
    :init 
      (add-hook 'pdf-tools-enabled-hook 
        (lambda () (setq-local beacon-mode nil))))
#+END_SRC

* Navigation
#+BEGIN_SRC emacs-lisp
  ;; It is possible to change windows in Emacs using 'C-x o', but
  ;; sometimes 'C-tab' still feels more intuitive to me.
  (global-set-key [C-tab] 'other-window)
  (global-set-key [C-iso-lefttab]
    (lambda ()
      (interactive)
      (other-window -1)))

  ;; Avy goto-char lets you jump to a given char on the screen just by
  ;; pressing 'C-.'.
  (use-package avy
    :ensure t
    :bind (
      ("C-." . avy-goto-char)
      ("C-ç" . avy-goto-char) ))

  (use-package windmove
    :ensure t
    :config
      (windmove-default-keybindings 'super)
      (setq windmove-wrap-around t))

  ;; Make windmove work in org-mode:
  (add-hook 'org-shiftup-final-hook 'windmove-up)
  (add-hook 'org-shiftleft-final-hook 'windmove-left)
  (add-hook 'org-shiftdown-final-hook 'windmove-down)
  (add-hook 'org-shiftright-final-hook 'windmove-right)

  ;; Better defaults via crux.
  ;(use-package crux
  ;  :bind (("C-a" . crux-move-beginning-of-line)))

  ;; Rectangle editing.
  (global-set-key (kbd "C-x <SPC>") 'cua-rectangle-mark-mode)
  
  ;; Window movement.
  (use-package ace-window
    :ensure t
    :config (global-set-key (kbd "M-o") 'ace-window))

  ;; We can follow links with goto-addr
  (use-package goto-addr
    :hook ((compilation-mode . goto-address-mode)
           (prog-mode . goto-address-prog-mode)
           (eshell-mode . goto-address-mode)
           (shell-mode . goto-address-mode))
    :bind (:map goto-address-highlight-keymap
                ("<RET>" . goto-address-at-point)
                ("M-<RET>" . newline))
    :commands (goto-address-prog-mode
               goto-address-mode))

  ;; We can narrow org buffers; sometimes we want an independent indirect buffer,
  ;; and this function creates it directly.
  ;; https://irreal.org/blog/?p=2602
  (defun narrow-to-region-indirect-buffer (start end)
    (interactive "r")
    (with-current-buffer (clone-indirect-buffer 
                          (generate-new-buffer-name 
                           (concat (buffer-name) "-indirect-" 
                                   (number-to-string start) "-" 
                                   (number-to-string end)))
                          'display)
      (narrow-to-region start end)
      (deactivate-mark)
      (goto-char (point-min))))

  (define-key global-map (kbd "C-x n b") 'narrow-to-region-indirect-buffer)
  (provide 'narrow-to-region-indirect-buffer)

  ;; Neotree provides a tree for directory navigation.
  (use-package neotree 
    :ensure t
    :config 
      (setq neo-theme 'arrow)
      (global-set-key [f9] 'neotree-toggle))

  ;; Ripgrep is an improved grep command.
  (use-package deadgrep
    :ensure t)

  ;; Ranger-style dired.
  (use-package ranger
    :ensure t)

  ;; Global line mode
  (global-visual-line-mode t)
#+END_SRC

* Org-mode
** Modules, plus-contrib
#+BEGIN_SRC emacs-lisp
  (use-package org
    :ensure org-plus-contrib
    :config (define-key org-mode-map (kbd "C-<tab>") nil))

  ;(require 'org-drill)
  ;(require 'org-habit)
  (require 'org-checklist)

  ;; List of modules
  ;(add-to-list 'org-modules "org-drill")
  ;; (add-to-list 'org-modules "org-bbdb")
  ;; (add-to-list 'org-modules "org-bibtex")
  ;; (add-to-list 'org-modules "org-docview")
  ;; (add-to-list 'org-modules "org-gnus")
  ;; (add-to-list 'org-modules "org-habit")
  ;; (add-to-list 'org-modules "org-info")
  ;; (add-to-list 'org-modules "org-irc")
  ;; (add-to-list 'org-modules "org-mhe")
  ;; (add-to-list 'org-modules "org-protocol")
  ;; (add-to-list 'org-modules "org-rmail")
  ;; (add-to-list 'org-modules "org-w3m")
  ;; (add-to-list 'org-modules "org-checklist")
#+END_SRC

** org-ref
#+BEGIN_SRC emacs-lisp
(use-package org-ref
  :ensure t
  :config 
    (setq org-ref-notes-directory "~/org/")
    (setq org-ref-bibliography-notes "~/org/Math.org")
    (setq org-ref-default-bibliography '("~/org/Math.bib"))
    (setq org-ref-pdf-directory "~/pdf/"))
#+END_SRC

*** Alternative click
#+BEGIN_SRC emacs-lisp
; Clicking into a reference should point you to the paper.
(defun m42/org-ref-cite-click (_key)
  (interactive)
  (setq paperid (thing-at-point 'word 'no-properties))
  (message "%s" paperid)
  (save-excursion (save-restriction
    (find-file "~/org/Math.org")
    (widen)
    (beginning-of-buffer)
    (if (search-forward (concat ":CUSTOM_ID: " paperid))
      (if (org-entry-get (point) "CUSTOM_ID")
        (org-noter)
        (message "No Interleave PDF found."))
      (message "No entry with CUSTOM_ID found.")
      ))))

(setq org-ref-cite-onclick-function 'm42/org-ref-cite-click)
#+END_SRC

#+RESULTS:
: m42/org-ref-cite-click

** helm/ivy-bibtex
#+BEGIN_SRC emacs-lisp
(use-package ivy-bibtex
  :ensure t
  :config 
    ;; Points where your pdfs etc are stored and the bibtex file.
    (setq bibtex-completion-library-path "~/pdf/")
    (setq bibtex-completion-bibliography "~/latex/bibliography.bib")
    (setq bibtex-completion-notes-path "~/org/Math.org")

    ;; Cite completion with C-c ñ
    (global-set-key (kbd "C-c ñ") 'ivy-bibtex)
    (setq ivy-bibtex-default-action 'ivy-bibtex-insert-citation))
#+END_SRC

#+RESULTS:
: t

** org-link-frame
#+BEGIN_SRC emacs-lisp
(setq org-link-frame-setup '(
  (vm . vm-visit-folder-other-frame)
  (vm-imap . vm-visit-imap-folder-other-frame)
  (gnus . org-gnus-no-new-news)
  (file . find-file-other-window)
  (wl . wl-other-frame)
  (cite . org-noter)
  ))
#+END_SRC

** Agenda
#+BEGIN_SRC emacs-lisp
  ;; Agenda commands.  Builds the personal agenda.
  (setq org-agenda-custom-commands
     '(("c" "Complete agenda, todo and waiting tasks" (

            ;; High priority tasks
            (tags-todo "-habit-notask+TODO=\"TODO\"-WAITUNTIL>\"<today>\"+PRIORITY=\"A\"" (
               (org-agenda-overriding-header "Priority")
               ;(org-agenda-files '("~/org/agenda/Tasks.org"))
               ))

            ;; Agenda and calendar
            (agenda "" (
               (org-agenda-overriding-header "Agenda") 
               (org-agenda-skip-function '(org-agenda-skip-entry-if 'regexp ":habit:"))
               ;(org-agenda-files '("~/org/agenda/Tasks.org" "~/org/GCalendar.org"))
               ))

            ;; Habits
            ;; (tags-todo "+habit-SCHEDULED>\"<today>\"" (
            ;;    (org-agenda-overriding-header "Habits")
            ;;    (org-agenda-files '("~/org/agenda/Tasks.org"))
            ;;    ))

            ;; General to-do's
            (tags-todo "-habit-notask+TODO=\"TODO\"-SCHEDULED>\"<today>\"-WAITUNTIL>\"<today>\"-PRIORITY=\"A\"-PRIORITY=\"C\"" (
               (org-agenda-overriding-header "Tasks")
               ;(org-agenda-files '("~/org/agenda/Tasks.org"))
               ))

           ;; Non-priority tasks
            (tags-todo "-habit-notask+TODO=\"TODO\"-SCHEDULED>\"<today>\"-WAITUNTIL>\"<today>\"+PRIORITY=\"C\"" (
               (org-agenda-overriding-header "Non-priority")
               ;(org-agenda-files '("~/org/agenda/Tasks.org"))
               ))


            ;; Waiting tasks
            ;; (tags-todo "-habit-notask+TODO=\"WAIT\"-SCHEDULED>\"<today>\"" (
            ;;    (org-agenda-overriding-header "Waiting")
            ;;    (org-agenda-files '("~/org/agenda/Tasks.org"))
            ;;    ))
            ))))

  ;; Agenda filters.
  (setq org-agenda-tag-filter-preset '("-notask"))
  (setq org-agenda-files '("~/org/GCalendar.org" "~/org/agenda" "~/org/math/notes"))
  (setq org-agenda-skip-scheduled-if-done t)
  (setq org-agenda-todo-ignore-scheduled 'past)
  (setq org-agenda-show-future-repeats nil)
  (setq org-agenda-start-day "-1d")
  (setq org-agenda-span 7)
  (setq org-agenda-skip-deadline-if-done t)
  (setq org-agenda-start-on-weekday nil)

  ;; Blocked tasks become invisible.
  ;; https://orgmode.org/manual/TODO-dependencies.html#TODO-dependencies
  (setq org-agenda-dim-blocked-tasks 'invisible)

  ;; Extensible dependencies for the org-mode agenda.
  (use-package org-edna
    :ensure t
    :config
      (org-edna-load))

  ;; Show only today's habits.
  (setq org-habit-show-habits-only-for-today t)

  ;; Prefix format for the Emacs agenda.
  (setq org-agenda-prefix-format 
    '((agenda . " %i %-12:c%?-12t% s")
     (todo . " %i %-12:c")
     (tags . " %i %-12:c")
     (search . " %i %-12:c")))

  ;; This makes the q command bury the agenda buffer when you've finished
  ;; with it, rather than close it. The result of this is that the agenda
  ;; will reappear immediately when you next ask for it, but it won't have
  ;; been updated since you last saw it. If you want it updated you can
  ;; always press g in the agenda to rebuild it properly.
  ;; https://emacs.stackexchange.com/a/861/12208
  (setq org-agenda-sticky t)

  ;; The block separator in the agenda. It has to be declared as a number.
  ;; For instance, 32 is the whitespace.
  (setq org-agenda-block-separator 32)

  ;; I prefer the mini-calendar prompt to start on Monday.
  ;; https://emacs.stackexchange.com/questions/42571/org-agenda-date-prompt-mini-calendar-start-week-on-monday
  (setq calendar-week-start-day 1)

  ;; Pregenerates an agenda buffer whenever Emacs is idle for more than 5
  ;; seconds. The next time the agenda command is run, generation takes
  ;; less than a second, since the org buffers have already been loaded.
  ;; https://emacs.stackexchange.com/a/820/12208
  ;  
  ;; Currently disabled because it blocks Emacs too often.
  ; (run-with-idle-timer 5 nil (lambda () (org-agenda-list) (delete-window)))

  ;; Automatically rebuilds the agenda when idle.
  ;  Currently disabled because it blocks Emacs too often.
  ;; (defun renewOrgBuffer ()
  ;;   (interactive)
  ;;   (dolist (buffer (buffer-list))
  ;;     (with-current-buffer buffer
  ;;       (when (derived-mode-p 'org-agenda-mode)
  ;;     (org-agenda-maybe-redo))))
  ;;   )
  ;; (run-with-idle-timer 60 1000 #'renewOrgBuffer)
#+END_SRC

#+RESULTS:
: 1

** org-refile
From [[https://www.reddit.com/r/emacs/comments/4366f9/how_do_orgrefiletargets_work/czg008y/][this reddit comment]].

#+BEGIN_SRC emacs-lisp
(setq org-math-wiki-files (directory-files "~/org/math/wiki/" 'full "org"))

(setq org-refile-targets '(
   (nil :maxlevel . 2) 
   (org-agenda-files :maxlevel . 2) 
   (org-math-wiki-files :maxlevel . 1)
   ("~/org/Someday.org" :maxlevel . 2)
   ("~/org/agenda/Tasks.org" :maxlevel . 2)
   ("~/org/Reference.org" :maxlevel . 2)
   ("~/org/Notes.org" :maxlevel . 2)
   ("~/org/agenda/Inbox.org" :maxlevel . 1)
   ("~/org/Archive.org" :maxlevel . 1)
   ("~/org/math" :maxlevel . 1))
)
(setq org-outline-path-complete-in-steps nil)         ; Refile in a single go
(setq org-refile-use-outline-path t)                  ; Show full paths for refiling
(setq org-refile-allow-creating-parent-nodes 'confirm)

;; From this post, how to refile to the top level.
;; https://blog.aaronbieber.com/2017/03/19/organizing-notes-with-refile.html
(setq org-refile-use-outline-path 'file)
(setq org-outline-path-complete-in-steps nil)

;; Save all buffers after refiling or archiving.
(advice-add 'org-refile :after (lambda (&rest _) (org-save-all-org-buffers)))
(advice-add 'org-archive-subtree :after (lambda (&rest _) (org-save-all-org-buffers)))

;; Stores org files in ~/org. Defines location of index, agenda and todo files.
(setq org-directory m42/org-folder)
(setq org-archive-location (concat m42/archive-file "::* From %s"))
#+END_SRC

** org-download
#+BEGIN_SRC emacs-lisp
(use-package org-download
  :ensure t
  :config 
    (setq org-download-image-dir "~/org/images")
    (setq org-download-heading-lvl nil)
  :bind ("M-<print>" . org-download-screenshot))
#+END_SRC

** Keybindings
#+BEGIN_SRC emacs-lisp
  ;; Quickly jumps between headers.
  ;; https://emacs.stackexchange.com/a/32625/12208
  (setq org-goto-interface 'outline-path-completion)
  (setq org-outline-path-complete-in-steps nil)
  (setq org-goto-max-level 2)

  ;; Speed commands work on headers. Pressing =n= there, for instance,
  ;; jumps to the next header.
  (setq org-use-speed-commands t)

  ;; These are basic keybindings for the agenda and org-capture.
  (setq org-export-coding-system 'utf-8)
  (global-set-key "\C-cl" 'org-store-link)
  (global-set-key "\C-ca" 'org-agenda)
  (global-set-key (kbd "C-c c") 'org-capture)
  (global-set-key "\C-cb" 'org-iswitchb)

  ;; Navigation between headings made easier.
  (add-hook 'org-mode-hook 
     (lambda ()
       (local-set-key "\M-n" 'outline-next-visible-heading)
       (local-set-key "\M-p" 'outline-previous-visible-heading)))

  ;; When set to t, asks for confirmation each time it executes an elisp
  ;; block.
  (setq org-confirm-elisp-link-function nil)
#+END_SRC

** Customization
#+BEGIN_SRC emacs-lisp
  ;; Pretty entities automatically draws '\alpha' as α when set as t.
  (setq org-pretty-entities nil)

  ;; Hierarchical statistics for checkboxes. checkboxes in subheaders
  ;; are considered for statistics when this is set as t.
  (setq org-checkbox-hierarchical-statistics t)

  ;; Sets a single bullet in org mode whose symbol is the asterisk. That
  ;; feels more sensible than having a list of different symbols.
  (use-package org-bullets :ensure t)
  (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))
  (setq org-bullets-bullet-list '("*"))

  ;; Automatically pseudoindents headers in org-mode when set to t.
  (setq org-startup-indented t)

  ;; Sets the emphasis for each one of the markers. In particular,
  ;; having 'ultra-bold' is useful when using Iosevka, that has a bold
  ;; version that is difficult to distinguish from the normal one.
  (setq org-emphasis-alist 
    '(("*" (:weight ultra-bold)) 
      ("/" italic) 
      ("_" underline) 
      ("=" org-verbatim verbatim) 
      ("~" org-code verbatim) 
      ("+" (:strike-through t))))

  ;; Hides emphasis markers while writing when set to t.
  (setq org-hide-emphasis-markers t)

  ;; Sets the column that tags must use.
  (setq org-tags-column 0)

  ;; "I tend to leave a blank line at the end of the content of each task
  ;; entry. This causes Org to automatically place a blank line before a
  ;; new heading or plain text list item, just the way I like it."
  ;; https://blog.aaronbieber.com/2016/01/30/dig-into-org-mode.html
  (setq org-blank-before-new-entry (quote ((heading . t) (plain-list-item . auto))))

  ;; "I like to know when tasks have changed status. Setting this option
  ;; causes Org to insert an annotation in a task when it is marked as
  ;; done including a timestamp of when exactly that happened."
  ;; https://blog.aaronbieber.com/2016/01/30/dig-into-org-mode.html
  (setq org-log-done (quote time))

  ;; "Adding yet further auditing, this option causes Org to insert
  ;; annotations when you change the deadline of a task, which will note
  ;; the previous deadline date and when it was changed. Very useful for
  ;; figuring out how many times you “kicked the can down the road.”"
  ; (setq org-log-redeadline (quote time))
  ; (setq org-log-reschedule (quote time))
#+END_SRC

** Export
#+BEGIN_SRC emacs-lisp
  ;; Exporting to latex.
  (require 'ox-latex)

  ;; Exports to beamer. It needs to first define the beamer class.
  (add-to-list 'org-latex-classes
      '("beamer"
	"\\documentclass\[presentation\]\{beamer\}"
	("\\section\{%s\}" . "\\section*\{%s\}")
	("\\subsection\{%s\}" . "\\subsection*\{%s\}")
	("\\subsubsection\{%s\}" . "\\subsubsection*\{%s\}")))
  (require 'ox-beamer)

  ;; Exporting ignores headlines.
  (require 'ox-extra)
  (ox-extras-activate '(ignore-headlines))

  ;; Classes for latex exporting
  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
      '("scrbook" "\\documentclass{scrbook}"
       ("\\part{%s}" . "\\part*{%s}")
       ("\\chapter{%s}" . "\\chapter*{%s}")
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}"))))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
      '("jfp" "\\documentclass{jfp}"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
      '("tac" "\\documentclass{tac}"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
      '("amsart" "\\documentclass{amsart}"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}")
       )))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
      '("ociamthesis" "\\documentclass{ociamthesis}"
       ("\\chapter{%s}" . "\\chapter*{%s}")
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}")
       )))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
	       '("scrreprt" "\\documentclass{scrreprt}"
		 ("\\part{%s}" . "\\part*{%s}")
		 ("\\chapter{%s}" . "\\chapter*{%s}")
		 ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 ("\\paragraph{%s}" . "\\paragraph*{%s}"))))

  (with-eval-after-load "ox-latex"
    (add-to-list 'org-latex-classes
	       '("myifcolog" "\\documentclass{myifcolog}"
		 ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 ("\\subsubsubsection{%s}" . "\\subsubsubsection*{%s}")
		 ("\\paragraph{%s}" . "\\paragraph*{%s}")
		 ("\\paragraph{%s}" . "\\paragraph*{%s}"))))


  ;; Exports minted code in latex.
  (setq org-latex-listings 'minted)
  ;(setq org-latex-packages-alist '(("" "minted")))
  ;(setq org-latex-minted-options '(("frame" "lines")))

  ;; The configuration allows us to do Reveal.js presentations using org-mode.
  ;; http://cestlaz.github.io/posts/using-emacs-11-reveal
  ;; (use-package ox-reveal 
  ;;   :init 
  ;;     (setq org-reveal-root "http://cdn.jsdelivr.net/reveal.js/3.0.0/")
  ;;     (setq org-reveal-mathjax t))

  ;; (use-package htmlize)

  ;; ;; Twitter bootstrap exporting.
  ;; (use-package ox-twbs :ensure ox-twbs)
#+END_SRC

#+RESULTS:
: minted

** Babel
#+BEGIN_SRC emacs-lisp
  ;; Loads 'org-babel' language packages.
  (require 'ob-C)
  (require 'ob-python)

  ;; Function declaring the loaded languages.
  (org-babel-do-load-languages
   'org-babel-load-languages
    '( (ruby . t)
       (python . t)
       (haskell . t)
       (C . t)
       (emacs-lisp . t)
       (ditaa . t)
       (sagemath . t)
       (latex . t)
       (shell . t)
     ))

  ;; Untangles single blocks of code with a keystroke.
  (global-set-key (kbd "C-º") (lambda () (interactive) (org-babel-tangle '(4))))

  ;; Uses 'runhaskell' when it outputs the results. Taken from a great
  ;; article (in Japanese!) by Yoshinari Nomura.
  ;; http://quickhack.net/nom/blog/2012-08-31-org-babel-and-haskell.html]
  (defadvice org-babel-haskell-initiate-session
      (around org-babel-haskell-initiate-session-advice)
      (let* ((buff (get-buffer "*haskell*"))
             (proc (if buff (get-buffer-process buff)))
             (type (cdr (assoc :result-type 'params)))
             (haskell-program-name
              (if (equal type 'output) "runhaskell-ob" "ghci")))
        (if proc (kill-process proc))
        (sit-for 0)
        (if buff (kill-buffer buff))
          ad-do-it))  

  (ad-activate 'org-babel-haskell-initiate-session)

  ;; Path to Ditaa
  (setq org-ditaa-jar-path "/usr/share/java/ditaa/ditaa-0_9.jar")

  ;; https://emacs.stackexchange.com/a/8168/12208
  (setq org-src-window-setup 'current-window)

  ;; Preserve indentation and blank spaces. This also works when
  ;; exporting with minted.
  ;; https://anbasile.github.io/programming/2016/12/02/org-babel-is-cool/
  (setq org-src-preserve-indentation t)
#+END_SRC

#+RESULTS:
: t

*** Sage
#+BEGIN_SRC emacs-lisp
  ;; Ob-sagemath supports only evaluating with a session.
  (setq org-babel-default-header-args:sage '((:session . t)
                                             (:results . "output")))

  ;; C-c c for asynchronous evaluating (only for SageMath code blocks).
  ;  (with-eval-after-load "org"
  ;     (define-key org-mode-map (kbd "C-c c") 'ob-sagemath-execute-async))

  ;; Do not confirm before evaluation
  (setq org-confirm-babel-evaluate nil)

  ;; Do not evaluate code blocks when exporting.
  ; (setq org-export-babel-evaluate nil)

  ;; Show images when opening a file.
  (setq org-startup-with-inline-images t)

  ;; Show images after evaluating code blocks.
  (add-hook 'org-babel-after-execute-hook 'org-display-inline-images)
#+END_SRC

** Latex in org
#+BEGIN_SRC emacs-lisp
  ;; Keybinding for previewing formulas in latex.
  (global-set-key (kbd "C-ñ") 'org-toggle-latex-fragment)

  ;; Zooming.
  (setq org-format-latex-options (plist-put org-format-latex-options :scale 1.2))

  ;; Abbreviations on 'latex-math-mode'. They require Latex to use
  ;; =latex-math-mode=. It is activated by default.
  (customize-set-variable 'LaTeX-math-abbrev-prefix "ç")
  (setq LaTeX-math-list
    (quote
      ((";" "mathbb{" "" nil)
       ("=" "cong" "" nil)
       ("<right>" "longrightarrow" "" nil)
       ("<left>" "longleftarrow" "" nil)
       ("C-<right>" "Longrightarrow" "" nil)
       ("C-<left>" "Longleftarrow" "" nil)
       ("^" "widehat" "" nil)
       ("~" "widetilde" "" nil)
       ("'" "\partial" "" nil)
       ("0" "varnothing" "" nil)
       ("C-(" "left(" "" nil)
       ("C-)" "right)" "" nil)
       )))

  ;; Auctex configuration
  (use-package tex :ensure auctex)
  (require 'latex)
  (add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
  (add-hook 'org-mode-hook 'LaTeX-math-mode)

  ;; cd-latex provides sensible keybindings for writing math.
  (use-package cdlatex :ensure t)
  (add-hook 'org-mode-hook 'turn-on-org-cdlatex)

  ;; Some packages must be added at the latex preview alist.  In
  ;; particular, this adds preview of commutative diagrams with the
  ;; 'tikz-cd' package.
  (eval-after-load "preview"
    '(add-to-list 'preview-default-preamble "\\PreviewEnvironment{tikzpicture}" t))

  ;; Sets the backend for latex. Imagemagick works best with tikzcd.
  (setq org-preview-latex-default-process 'imagemagick)

  ;; No default packages should be loaded.
  (setq org-latex-default-packages-alist '())
#+END_SRC

** Notes and spaced repetition
#+BEGIN_SRC emacs-lisp
  ;; Org-noter provides support for note-taking on PDFs.
  (use-package org-noter :ensure t)

  ;; These options set where it will store the pdf and the location of
  ;; the notes.  They are the same ones that the Interleave package used,
  ;; keeping compatibility with it.
  (setq org-noter-property-doc-file "INTERLEAVE_PDF")
  (setq org-noter-property-note-location "INTERLEAVE_PAGE_NOTE")


  ;; Org-drill configurations. These variables control how org-drill
  ;; will work internally.
  (setq org-drill-learn-fraction 0.35)
  ;; It adds random noise to the retrieval process.
  (setq org-drill-add-random-noise-to-intervals-p t)
  ;; Limits the time an org-drill session can last.
  (setq org-drill-maximum-duration 25)
  ;; After the session, save all buffers.
  (setq org-drill-save-buffers-after-drill-sessions-p nil)
  (setq org-drill-hide-item-headings-p t)
  ;; Work on the whole directory
  (setq org-drill-scope 'file)

  ;; This is an auxiliary function that lets you study a single subtree
  ;; of an org file. It simply calls 'org-drill-cram' with the 'tree'
  ;; parameter.
  (defun m42/org-drill-cram-tree () (interactive) (org-drill-cram 'tree))

  ;; Org-id automatically provides an ID for each header when necessary:
  ;; for example, when creating a link.
  (require 'org-id)
  
  ;; We only want it to work if no custom id has been already created.
  (setq org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)

  ;; Sensible defaults for ispell on org-mode, avoiding markers.
  ;; http://endlessparentheses.com/ispell-and-org-mode.html
  (defun endless/org-ispell ()
    "Configure `ispell-skip-region-alist' for `org-mode'."
    (make-local-variable 'ispell-skip-region-alist)
    (add-to-list 'ispell-skip-region-alist '(org-property-drawer-re))
    (add-to-list 'ispell-skip-region-alist '("~" "~"))
    (add-to-list 'ispell-skip-region-alist '("=" "="))
    (add-to-list 'ispell-skip-region-alist '("$" "$"))
    (add-to-list 'ispell-skip-region-alist '("\\[" "\\]"))
    (add-to-list 'ispell-skip-region-alist '("^#\\+BEGIN_SRC" . "^#\\+END_SRC")))
  (add-hook 'org-mode-hook #'endless/org-ispell)
#+END_SRC

** Capture
#+BEGIN_SRC emacs-lisp
  (require 'org-protocol)
  
  ;; List of org-capture-templates.
  (setq org-capture-templates (quote (
    ("j" "Journal" entry (file+datetree "~/org/Diary.org")
         "* %?" :empty-lines 1)
    ("r" "Research" entry (file+datetree "~/org/math/Research.org")
         "* %?" :empty-lines 1)
    ("c" "Contact" entry (file+headline "~/org/Contacts.org" "Inbox")
      "* %^{Name}
  :PROPERTIES:
  :EMAIL: %^{Email}
  :BIRTHDAY: %^{yyyy-mm-dd}
  :NOTE: %^{Note}
  :END:"
        :empty-lines 1)
      ("m" "mail" entry (file+headline "~/org/agenda/Tasks.org" "Mail")
           "* TODO [#A] %?\nSCHEDULED: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n%a\n\n")
      ("t" "todo" entry (file "~/org/agenda/Inbox.org")
           "* TODO %?\n:PROPERTIES:\n:CREATED: %(org-insert-time-stamp(org-read-date nil t \"+0d\"))\n:END:\n\n\n")
    )))
#+END_SRC

#+RESULTS:

** org-index
#+BEGIN_SRC emacs-lisp
  (use-package org-index
    :ensure t
    :config (global-set-key "\C-ci" 'org-index))
#+END_SRC

* Programming
** Markdown
#+BEGIN_SRC emacs-lisp
;; Markdown
(use-package markdown-mode :ensure t)
(set-face-attribute 'fixed-pitch nil 
   :family "unspecified")
#+END_SRC

** Lisp
#+BEGIN_SRC emacs-lisp
  ;; Evaluates Lisp in place with 'C-c e'.
  ;; http://emacsredux.com/blog/2013/06/21/eval-and-replace/
  (defun eval-and-replace ()
    "Replace the preceding sexp with its value."
    (interactive)
    (backward-kill-sexp)
    (condition-case nil
        (prin1 (eval (read (current-kill 0)))
               (current-buffer))
      (error (message "Invalid expression")
             (insert (current-kill 0)))))
  (global-set-key (kbd "C-c e") 'eval-and-replace)
#+END_SRC

** Idris
#+BEGIN_SRC emacs-lisp
(use-package idris-mode :ensure t)
#+END_SRC

** Latex
#+BEGIN_SRC emacs-lisp
  (use-package tex 
    :ensure auctex)

  (add-hook 'LaTeX-mode-hook (lambda () (local-set-key (kbd "C-ñ") #'preview-buffer)))
  (add-hook 'LaTeX-mode-hook
          '(lambda ()
            (define-key LaTeX-mode-map (kbd "$") 'self-insert-command)))

  ;; Outline mode makes Latex behave like Org. It allows us to expand
  ;; and contract regions on a TeX file.
  (add-hook 'LaTeX-mode-hook #'outline-minor-mode)
#+END_SRC

*** outline magic
#+BEGIN_SRC emacs-lisp
;;; outline-magic.el --- outline mode extensions for Emacs

;; Copyright (C) 2002, 2013 Carsten Dominik, Thorsten Jolitz

;; Author: Carsten Dominik <dominik@science.uva.nl>
;; Maintainer: Thorsten Jolitz <tjolitz AT gmail DOT com>
;; Version: 0.9.1
;; Keywords: outlines

;; This file is not part of GNU Emacs.

;; GNU Emacs is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 2, or (at your option)
;; any later version.

;; GNU Emacs is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING.  If not, write to the
;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;;; Commentary:

;; This file implements extensions for outline(-minor)-mode.
;;
;; - VISIBILITY CYCLING: A *single* command to replace the many
;;   outline commands for showing and hiding parts of a document.
;;
;; - STRUCTURE EDITING: Promotion, demotion and transposition of subtrees.
;;
;; Installation
;; ============
;;
;; Byte-compile outline-magic.el, put it on the load path and copy the
;; following into .emacs (adapting keybindings to your own preferences)
;;
;; (add-hook 'outline-mode-hook
;;           (lambda ()
;;             (require 'outline-cycle)))
;;
;; (add-hook 'outline-minor-mode-hook
;;           (lambda ()
;;             (require 'outline-magic)
;;             (define-key outline-minor-mode-map [(f10)] 'outline-cycle)))
;;
;; Usage
;; =====
;;
;; Visibility cycling
;; ------------------
;;
;; The command `outline-cycle' changes the visibility of text and headings
;; in the buffer.  Instead of using many different commands to show and
;; hide buffer parts, `outline-cycle' cycles through the most important
;; states of an outline buffer.  In the major `outline-mode', it will be
;; bound to the TAB key.  In `outline-minor-mode', the user can choose a
;; different keybinding.  The action of the command depends on the current
;; cursor location:
;;
;; 1. When point is at the beginning of the buffer, `outline-cycle'
;;    cycles the entire buffer through 3 different states:
;;      - OVERVIEW: Only top-level headlines are shown.
;;      - CONTENTS: All headlines are shown, but no body text.
;;      - SHOW ALL: Everything is shown.
;;
;; 2. When point in a headline, `outline-cycle' cycles the subtree started
;;    by this line through the following states:
;;      - FOLDED:   Only the headline is shown.
;;      - CHILDREN: The headline and its direct children are shown.  From
;;                  this state, you can move to one of the children and
;;                  zoom in further.
;;      - SUBTREE:  The entire subtree under the heading is shown.
;;
;; 3. At other positions, `outline-cycle' jumps back to the current heading.
;;    It can also be configured to emulate TAB at those positions, see
;;    the option `outline-cycle-emulate-tab'.
;;
;; Structure editing
;; -----------------
;;
;; Four commands are provided for structure editing.  The commands work on
;; the current subtree (the current headline plus all inferior ones). In
;; addition to menu access, the commands are assigned to the four arrow
;; keys pressed with a modifier (META by default) in the following way:
;;
;;                                 move up
;;                                    ^
;;                        promote  <- | ->  demote
;;                                    v
;;                                move down
;;
;; Thus, M-left will promote a subtree, M-up will move it up
;; vertically throught the structure.  Configure the variable
;; `outline-structedit-modifiers' to use different modifier keys.
;;
;; Moving subtrees
;; - - - - - - - -
;; The commands `outline-move-subtree-up' and `outline-move-subtree-down'
;; move the entire current subtree (folded or not) past the next same-level
;; heading in the given direction.  The cursor moves with the subtree, so
;; these commands can be used to "drag" a subtree to the wanted position.
;; For example, `outline-move-subtree-down' applied with the cursor at the
;; beginning of the "* Level 1b" line will change the tree like this:
;;
;;   * Level 1a                         * Level 1a
;;   * Level 1b         ===\            * Level 1c
;;   ** Level 2b        ===/            * Level 1b
;;   * Level 1c                         ** Level 2b
;;
;; Promotion/Demotion
;; - - - - - - - - - -
;; The commands `outline-promote' and `outline-demote' change the current
;; subtree to a different outline level - i.e. the level of all headings in
;; the tree is decreased or increased.  For example, `outline-demote'
;; applied with the cursor at the beginning of the "* Level 1b" line will
;; change the tree like this:
;;
;;   * Level 1a                         * Level 1a
;;   * Level 1b         ===\            ** Level 1b
;;   ** Level 2b        ===/            *** Level 2
;;   * Level 1c                         * Level 1c
;;
;; The reverse operation is `outline-promote'.  Note that the scope of
;; "current subtree" may be changed after a promotion.  To change all
;; headlines in a region, use transient-mark-mode and apply the command to
;; the region.
;;
;; NOTE: Promotion/Demotion in complex outline setups
;; - - - - - - - - - - - - - - - - - - - - - - - - - -
;; Promotion/demotion works easily in a simple outline setup where the
;; indicator of headings is just a polymer of a single character (e.g. "*"
;; in the default outline mode).  It can also work in more complicated
;; setups.  For example, in LaTeX-mode, sections can be promoted to
;; chapters and vice versa.  However, the outline setup for the mode must
;; meet two requirements:
;;
;; 1. `outline-regexp' must match the full text which has to be changed
;;    during promotion/demotion.  E.g. for LaTeX, it must match "\chapter"
;;    and not just "\chap".  Major modes like latex-mode, AUCTeX's
;;    latex-mode and texinfo-mode do this correctly.
;;
;; 2. The variable `outline-promotion-headings' must contain a sorted list
;;    of headings as matched by `outline-regexp'.  Each of the headings in
;;    `outline-promotion-headings' must be matched by `outline-regexp'.
;;    `outline-regexp' may match additional things - those matches will be
;;    ignored by the promotion commands.  If a mode has multiple sets of
;;    sectioning commands (for example the texinfo-mode with
;;    chapter...subsubsection and unnumbered...unnumberedsubsubsec), the
;;    different sets can all be listed in the same list, but must be
;;    separated by nil elements to avoid "promotion" accross sets.
;;    Examples:
;;
;;    (add-hook 'latex-mode-hook      ; or 'LaTeX-mode-hook for AUCTeX
;;     (lambda ()
;;       (setq outline-promotion-headings
;;             '("\\chapter" "\\section" "\\subsection"
;;               "\\subsubsection" "\\paragraph" "\\subparagraph"))))
;;
;;    (add-hook 'texinfo-mode-hook
;;     (lambda ()
;;      (setq outline-promotion-headings
;;       '("@chapter" "@section" "@subsection" "@subsubsection" nil
;;         "@unnumbered" "@unnumberedsec" "@unnumberedsubsec"
;;                                       "@unnumberedsubsubsec" nil
;;         "@appendix" "@appendixsec" "@appendixsubsec"
;;                                         "@appendixsubsubsec" nil
;;         "@chapheading" "@heading" "@subheading" "@subsubheading"))))
;;
;;    If people find this useful enough, maybe the maintainers of the
;;    modes can be persuaded to set `outline-promotion-headings'
;;    already as part of the mode setup.
;;
;;  Compatibility:
;;  --------------
;;  outline-magic was developed to work with the new outline.el
;;  implementation which uses text properties instead of selective display.
;;  If you are using XEmacs which still has the old implementation, most
;;  commands will work fine.  However, structure editing commands will
;;  require all relevant headlines to be visible.
;;
;;; Code:

(require 'outline)

;;; Visibility cycling

(defcustom outline-cycle-emulate-tab nil
  "Where should `outline-cycle' emulate TAB.
nil    Never
white  Only in completely white lines
t      Everywhere except in headlines"
  :group 'outlines
  :type '(choice (const :tag "Never" nil)
		 (const :tag "Only in completely white lines" white)
		 (const :tag "Everywhere except in headlines" t)
		 ))

(defvar outline-promotion-headings nil
  "A sorted list of headings used for promotion/demotion commands.
Set this to a list of headings as they are matched by `outline-regexp',
top-level heading first.  If a mode or document needs several sets of
outline headings (for example numbered and unnumbered sections), list
them set by set, separated by a nil element.  See the example for
`texinfo-mode' in the file commentary.")
(make-variable-buffer-local 'outline-promotion-headings)

;;;###autoload
(defun outline-cycle (&optional arg)
  "Visibility cycling for outline(-minor)-mode.

- When point is at the beginning of the buffer, or when called with a
  C-u prefix argument, rotate the entire buffer through 3 states:
  1. OVERVIEW: Show only top-level headlines.
  2. CONTENTS: Show all headlines of all levels, but no body text.
  3. SHOW ALL: Show everything.

- When point is at the beginning of a headline, rotate the subtree started
  by this line through 3 different states:
  1. FOLDED:   Only the main headline is shown.
  2. CHILDREN: The main headline and the direct children are shown.  From
               this state, you can move to one of the children and
               zoom in further.
  3. SUBTREE:  Show the entire subtree, including body text.

- When point is not at the beginning of a headline, execute
  `indent-relative', like TAB normally does."
  (interactive "P")
  (setq deactivate-mark t)
  (cond

   ((equal arg '(4))
    ; Run `outline-cycle' as if at the top of the buffer.
    (save-excursion
      (goto-char (point-min))
			(let ((current-prefix-argument nil))
      (outline-cycle nil))))

   (t
    (cond
     ((bobp) ;; Beginning of buffer: Global cycling

      (cond
       ((eq last-command 'outline-cycle-overview)
	;; We just created the overview - now do table of contents
	;; This can be slow in very large buffers, so indicate action
	(message "CONTENTS...")
	(save-excursion
	  ;; Visit all headings and show their offspring
	  (goto-char (point-max))
	  (catch 'exit
	    (while (and (progn (condition-case nil
				   (outline-previous-visible-heading 1)
				 (error (goto-char (point-min))))
			       t)
			(looking-at outline-regexp))
	      (show-branches)
	      (if (bobp) (throw 'exit nil))))
	  (message "CONTENTS...done"))
	(setq this-command 'outline-cycle-toc))
       ((eq last-command 'outline-cycle-toc)
	;; We just showed the table of contents - now show everything
	(show-all)
	(message "SHOW ALL")
	(setq this-command 'outline-cycle-showall))
       (t
	;; Default action: go to overview
	(let ((toplevel (cond
			 (current-prefix-arg (prefix-numeric-value current-prefix-arg))
			 ((save-excursion (beginning-of-line)
					  (looking-at outline-regexp))
			  (max 1 (funcall outline-level)))
			 (t 1))))
	  (hide-sublevels toplevel))
	(message "OVERVIEW")
	(setq this-command 'outline-cycle-overview))))

     ((save-excursion (beginning-of-line 1) (looking-at outline-regexp))
      ;; At a heading: rotate between three different views
      (outline-back-to-heading)
      (let ((goal-column 0) beg eoh eol eos)
	;; First, some boundaries
	(save-excursion
	  (outline-back-to-heading)           (setq beg (point))
	  (save-excursion (outline-next-line) (setq eol (point)))
	  (outline-end-of-heading)            (setq eoh (point))
	  (outline-end-of-subtree)            (setq eos (point)))
	;; Find out what to do next and set `this-command'
	(cond
	 ((= eos eoh)
	  ;; Nothing is hidden behind this heading
	  (message "EMPTY ENTRY"))
	 ((>= eol eos)
	  ;; Entire subtree is hidden in one line: open it
	  (show-entry)
	  (show-children)
	  (message "CHILDREN")
	  (setq this-command 'outline-cycle-children))
	 ((eq last-command 'outline-cycle-children)
	  ;; We just showed the children, now show everything.
	  (show-subtree)
	  (message "SUBTREE"))
	 (t
	  ;; Default action: hide the subtree.
	  (hide-subtree)
	  (message "FOLDED")))))

     ;; TAB emulation
     ((outline-cycle-emulate-tab)
      (indent-relative))

     (t
      ;; Not at a headline: Do indent-relative
      (outline-back-to-heading))))))

(defun outline-cycle-emulate-tab ()
  "Check if TAB should be emulated at the current position."
  ;; This is called after the check for point in a headline,
  ;; so we can assume we are not in a headline
  (if (and (eq outline-cycle-emulate-tab 'white)
	   (save-excursion
	     (beginning-of-line 1) (looking-at "[ \t]+$")))
      t
    outline-cycle-emulate-tab))

;;;###autoload
(defun outline-next-line ()
  "Forward line, but mover over invisible line ends.
Essentially a much simplified version of `next-line'."
  (interactive)
  (beginning-of-line 2)
  (while (and (not (eobp))
	      (get-char-property (1- (point)) 'invisible))
    (beginning-of-line 2)))

;;; Vertical tree motion

;;;###autoload
(defun outline-move-subtree-up (&optional arg)
  "Move the currrent subtree up past ARG headlines of the same level."
  (interactive "p")
  (let ((headers (or arg 1)))
    (outline-move-subtree-down (- headers))))

;;;###autoload
(defun outline-move-subtree-down (&optional arg)
  "Move the currrent subtree down past ARG headlines of the same level."
  (interactive "p")
  (let* ((headers (or arg 1))
        (re (concat "^" outline-regexp))
	(movfunc (if (> headers 0) 'outline-get-next-sibling
		   'outline-get-last-sibling))
	(ins-point (make-marker))
	(cnt (abs headers))
	beg end txt)
    ;; Select the tree
    (outline-back-to-heading)
    (setq beg (point))
    (outline-end-of-subtree)
    (if (= (char-after) ?\n) (forward-char 1))
    (setq end (point))
    ;; Find insertion point, with error handling
    (goto-char beg)
    (while (> cnt 0)
      (or (funcall movfunc)
	  (progn (goto-char beg)
		 (error "Cannot move past superior level")))
      (setq cnt (1- cnt)))
    (if (> headers 0)
	;; Moving forward - still need to move over subtree
	(progn (outline-end-of-subtree)
	       (if (= (char-after) ?\n) (forward-char 1))))
    (move-marker ins-point (point))
    (setq txt (buffer-substring beg end))
    (delete-region beg end)
    (insert txt)
    (goto-char ins-point)
    (move-marker ins-point nil)))

;;; Promotion and Demotion

;;;###autoload
(defun outline-promote (&optional arg)
  "Decrease the level of an outline-structure by ARG levels.
When the region is active in transient-mark-mode, all headlines in the
region are changed.  Otherwise the current subtree is targeted. Note that
after each application of the command the scope of \"current subtree\"
may have changed."
  (interactive "p")
  (let ((delta (or arg 1)))
    (outline-change-level (- delta))))

;;;###autoload
(defun outline-demote (&optional arg)
  "Increase the level of an outline-structure by ARG levels.
When the region is active in transient-mark-mode, all headlines in the
region are changed.  Otherwise the current subtree is targeted. Note that
after each application of the command the scope of \"current subtree\"
may have changed."
  (interactive "p")
  (let ((delta (or arg 1)))
    (outline-change-level delta)))

(defun outline-change-level (delta)
  "Workhorse for `outline-demote' and `outline-promote'."
  (let* ((headlist (outline-headings-list))
	 (atom (outline-headings-atom headlist))
	 (re (concat "^" outline-regexp))
	 (transmode (and transient-mark-mode mark-active))
	 beg end)

    ;; Find the boundaries for this operation
    (save-excursion
      (if transmode
	  (setq beg (min (point) (mark))
		end (max (point) (mark)))
	(outline-back-to-heading)
	(setq beg (point))
	(outline-end-of-heading)
	(outline-end-of-subtree)
	(setq end (point)))
      (setq beg (move-marker (make-marker) beg)
	    end (move-marker (make-marker) end))

      (let (head newhead level newlevel static)

	;; First a dry run to test if there is any trouble ahead.
	(goto-char beg)
	(while (re-search-forward re end t)
	  (outline-change-heading headlist delta atom 'test))

	;; Now really do replace the headings
	(goto-char beg)
	(while (re-search-forward re end t)
	  (outline-change-heading headlist delta atom))))))

(defun outline-headings-list ()
  "Return a list of relevant headings, either a user/mode defined
list, or an alist derived from scanning the buffer."
  (let (headlist)
    (cond
     (outline-promotion-headings
      ;; configured by the user or the mode
      (setq headlist outline-promotion-headings))

     ((and (eq major-mode 'outline-mode) (string= outline-regexp "[*\^L]+"))
      ;; default outline mode with original regexp
      ;; this need special treatment because of the \f in the regexp
      (setq headlist '(("*" . 1) ("**" . 2))))  ; will be extrapolated

     (t ;; Check if the buffer contains a complete set of headings
      (let ((re (concat "^" outline-regexp)) head level)
	(save-excursion
	  (goto-char (point-min))
	  (while (re-search-forward re nil t)
	    (save-excursion
	      (beginning-of-line 1)
	      (setq head (outline-cleanup-match (match-string 0))
		    level (funcall outline-level))
	      (add-to-list  'headlist (cons head level))))))
      ;; Check for uniqueness of levels in the list
      (let* ((hl headlist) entry level seen nonunique)
	(while (setq entry (car hl))
	  (setq hl (cdr hl)
		level (cdr entry))
	  (if (and (not (outline-static-level-p level))
		   (member level seen))
	      ;; We have two entries for the same level.
	      (add-to-list 'nonunique level))
	  (add-to-list 'seen level))
	(if nonunique
	    (error "Cannot promote/demote: non-unique headings at level %s\nYou may want to configure `outline-promotion-headings'."
		   (mapconcat 'int-to-string nonunique ","))))))
    ;; OK, return the list
    headlist))

(defun outline-change-heading (headlist delta atom &optional test)
  "Change heading just matched by `outline-regexp' by DELTA levels.
HEADLIST can be either an alist ((\"outline-match\" . level)...) or a
straight list like `outline-promotion-headings'. ATOM is a character
if all headlines are composed of a single character.
If TEST is non-nil, just prepare the change and error if there are problems.
TEST nil means, really replace old heading with new one."
  (let* ((head (outline-cleanup-match (match-string 0)))
	 (level (save-excursion
		  (beginning-of-line 1)
		  (funcall outline-level)))
	 (newhead  ; compute the new head
	  (cond
	   ((= delta 0) t)
	   ((outline-static-level-p level) t)
	   ((null headlist) nil)
	   ((consp (car headlist))
	    ;; The headlist is an association list
	    (or (car (rassoc (+ delta level) headlist))
		(and atom
		     (> (+ delta level) 0)
		     (make-string (+ delta level) atom))))
	   (t
	    ;; The headlist is a straight list - grab the correct element.
	    (let* ((l (length headlist))
		   (n1 (- l (length (member head headlist)))) ; index old
		   (n2 (+ delta n1)))                         ; index new
	      ;; Careful checking
	      (cond
	       ((= n1 l) nil)                ; head not found
	       ((< n2 0) nil)                ; newlevel too low
	       ((>= n2 l) nil)               ; newlevel too high
	       ((let* ((tail (nthcdr (min n1 n2) headlist))
		       (nilpos (- (length tail) (length (memq nil tail)))))
		  (< nilpos delta))          ; nil element between old and new
		nil)
	       (t (nth n2 headlist))))))))      ; OK, we have a match!
    (if (not newhead)
	(error "Cannot shift level %d heading \"%s\" to level %d"
	       level head (+ level delta)))
    (if (and (not test) (stringp newhead))
	(save-excursion
	  (beginning-of-line 1)
	  (or (looking-at (concat "[ \t]*\\(" (regexp-quote head) "\\)"))
	      (error "Please contact maintainer"))
	  (replace-match (outline-cleanup-match newhead) t t nil 1)))))

(defun outline-headings-atom (headlist)
  "Use the list created by `outline-headings-list' and check if all
headings are polymers of a single character, e.g. \"*\".
If yes, return this character."
  (if (consp (car headlist))
      ;; this is an alist - it makes sense to check for atomic structure
      (let ((re (concat "\\`"
			(regexp-quote (substring (car (car headlist)) 0 1))
			"+\\'")))
	(if (not (delq nil (mapcar (lambda (x) (not (string-match re (car x))))
				   headlist)))
	    (string-to-char (car (car headlist)))))))

(defun outline-cleanup-match (s)
  "Remove text properties and start/end whitespace from a string."
  (set-text-properties 1 (length s) nil s)
  (save-match-data
    (if (string-match "^[ \t]+" s) (setq s (replace-match "" t t s)))
    (if (string-match "[ \t]+$" s) (setq s (replace-match "" t t s))))
  s)

(defun outline-static-level-p (level)
  "Test if a level should not be changed by level promotion/demotion."
  (>= level 1000))

;;; Key bindings

(defcustom outline-structedit-modifiers '(meta)
  "List of modifiers for outline structure editing with the arrow keys."
  :group 'outlines
  :type '(repeat symbol))

(define-key outline-mode-map [(tab)] 'outline-cycle)
(let ((keys '((left . outline-promote)
	      (right . outline-demote)
	      (up . outline-move-subtree-up)
	      (down . outline-move-subtree-down)))
      key)
  (while (setq key (pop keys))
    (apply 'define-key outline-mode-map
	   (list
	    (vector (append outline-structedit-modifiers (list (car key))))
	    (cdr key)))))

;;; Menu entries

(define-key outline-mode-menu-bar-map [headings outline-move-subtree-down]
  '("Move subtree down" . outline-move-subtree-down))
(define-key outline-mode-menu-bar-map [headings outline-move-subtree-up]
  '("Move subtree up" . outline-move-subtree-up))
(define-key outline-mode-menu-bar-map [headings outline-demote]
  '("Demote by 1 level" . outline-demote))
(define-key outline-mode-menu-bar-map [headings outline-promote]
  '("Promote by 1 level" . outline-promote))
(define-key outline-mode-menu-bar-map [show outline-cycle]
  '("Rotate visibility" . outline-cycle))
(define-key outline-mode-menu-bar-map [hide outline-cycle]
  '("Rotate visibility" . outline-cycle))

;;; Finish up

; (provide 'outline-magic)

;;; outline-magic.el ends here
#+END_SRC

#+BEGIN_SRC emacs-lisp
 (add-hook 'outline-minor-mode-hook
           (lambda ()
             (define-key outline-minor-mode-map [(tab)] 'outline-cycle)
             (define-key outline-minor-mode-map (kbd "C-c C-n") 'outline-next-visible-heading)
             (define-key outline-minor-mode-map (kbd "C-c C-p") 'outline-previous-visible-heading)
             (setq outline-cycle-emulate-tab t)
             ))
#+END_SRC

#+RESULTS:

#+BEGIN_SRC emacs-lisp
;; extra outline headers 
(setq TeX-outline-extra
      '(("%chapter" 1)
        ("%section" 2)
        ("%subsection" 3)
        ("%subsubsection" 4)
        ("%paragraph" 5)))

;; add font locking to the headers
(font-lock-add-keywords
 'latex-mode
 '(("^%\\(chapter\\|\\(sub\\|subsub\\)?section\\|paragraph\\)"
    0 'font-lock-keyword-face t)
   ("^%chapter{\\(.*\\)}"       1 'font-latex-sectioning-1-face t)
   ("^%section{\\(.*\\)}"       1 'font-latex-sectioning-2-face t)
   ("^%subsection{\\(.*\\)}"    1 'font-latex-sectioning-3-face t)
   ("^%subsubsection{\\(.*\\)}" 1 'font-latex-sectioning-4-face t)
   ("^%paragraph{\\(.*\\)}"     1 'font-latex-sectioning-5-face t)))
#+END_SRC

#+RESULTS:

*** Pdf generation process
#+BEGIN_SRC emacs-lisp
  ;; This is the script Emacs will run when generating a PDF file from
  ;; an org mode file.
  (setq org-latex-pdf-process
	'("pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
    "bibtex %b"
    "makeindex %b"
    "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"
    "pdflatex -shell-escape -interaction nonstopmode -output-directory %o %f"))
#+END_SRC

*** Fontify-titles
#+BEGIN_SRC emacs-lisp
  (setq font-latex-fontify-sectioning 'color)
  (setq font-latex-fontify-sectioning 1.0)
  (setq font-latex-slide-title-face 1.0)
  (setq font-latex-fontify-script nil)
  (fset 'tex-font-lock-suscript 'ignore)

  ; (set-face-attribute 'font-latex-sectioning-1-face nil 
  ;    :weight 'bold
  ;    :height 1.0)

  ;(set-face-attribute 'font-latex-sectioning-2-face nil 
  ;   :weight 'bold
  ;   :height 1.0)

  ;(set-face-attribute 'font-latex-sectioning-3-face nil 
  ;   :weight 'bold
  ;   :height 1.0)
#+END_SRC
** Agda and Agda input
#+BEGIN_SRC emacs-lisp
  ;; Loads the =agda-mode= configuration. Agda provides the location
  ;; of its configuration file with the command =agda-mode locate=.
  ;; Locates agda-mode on the file system.
  (load-file (let ((coding-system-for-read 'utf-8))
                  (shell-command-to-string "agda-mode locate")))

  ;; Using the input method of Agda in LaTeX files.  Note that this
  ;; *needs* to go after the loading of Agda using "agda-mode" locate.
  (require 'agda-input)
  (add-hook 'LaTeX-mode-hook (lambda () (set-input-method "Agda")))
#+END_SRC

* Snippets
#+BEGIN_SRC emacs-lisp
  ;; Yasnippet provides support for snippets inside Emacs.
  (use-package yasnippet
    :ensure t
    :init (add-to-list 'load-path "~/.emacs.d/plugins/yasnippet")
    :config (yas-global-mode 1)
    :bind (("<C-dead-grave>" . yas-insert-snippet))
    )

  (add-hook 'term-mode-hook (lambda() (yas-minor-mode -1)))
  (add-hook 'term-mode-hook (lambda() (setq yas-dont-activate t)))

  (use-package haskell-snippets :ensure t)
#+END_SRC

They must be loaded with

 * =yas-recompile-all=
 * =yas-reload-all=

** aligned
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/aligned
# -*- mode: snippet -*-
# name: aligned
# key: %aligned
# --
\[\begin{aligned}
$1 
&=
&& \mbox{\texit{ (  ) }} \\\\&=
\end{aligned}\]
#+END_SRC

** square
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/square
# -*- mode: snippet -*-
# name: square
# key: %square
# --
\[\begin{tikzcd}
$1 \rar{$5} \dar[swap]{$6} & $2 \dar{$7} \\\\
$3 \rar{$8} & $4 
\end{tikzcd}\]
#+END_SRC

** statement
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/statement
# -*- mode: snippet -*-
# name: statement
# key: %state
# --
#+begin_statement
$1
#+end_statement
#+END_SRC

** note
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/note
# -*- mode: snippet -*-
# name: note
# key: %note
# --
#+begin_note
$1
#+end_note
#+END_SRC

** definition
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/definition
# -*- mode: snippet -*-
# name: definition
# key: %definition
# --
#+begin_definition
$1
#+end_definition
#+END_SRC

** lemma
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/lemma
# -*- mode: snippet -*-
# name: lemma
# key: %lemma
# --
#+begin_lemma
$1
#+end_lemma
#+END_SRC

** theorem
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/theorem
# -*- mode: snippet -*-
# name: theorem
# key: %theorem
# --
#+begin_theorem
$1
#+end_theorem
#+END_SRC

** proof
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/proof
# -*- mode: snippet -*-
# name: proof
# key: %proof
# --
#+begin_proof
$1
#+end_proof
#+END_SRC

** prop
#+BEGIN_SRC snippet :mkdirp yes :tangle ./snippets/org-mode/prop
# -*- mode: snippet -*-
# name: proposition
# key: %prop
# --
#+begin_proposition
$1
#+end_proposition
#+END_SRC

* Autocompletion
#+BEGIN_SRC emacs-lisp
  ;; Company provides autocompletion on Emacs.
  ;; This configuration was taken from malb's emacs.d.
  ;; https://github.com/malb/emacs.d/blob/master/malb.org#latex
  (use-package company
    :ensure t
    :config (progn
      (global-company-mode 1)
      (setq company-tooltip-limit 10)
      (setq company-idle-delay 0.5)
      (setq company-require-match nil)
      (setq company-minimum-prefix-length 3)
      (bind-key "<tab>" #'company-complete company-active-map)))

    ;; Completion for mathematics. We create a sane list of backends,
    ;; preventing some of them from firing while writing latex.
    (use-package company-math :ensure t)
    (add-to-list 'company-backends #'company-math-symbols-latex)
    (add-to-list 'company-backends #'company-math-latex-commands)
    (delete #'company-files company-backends)
#+END_SRC

* Customization
** Basic customization
Emacs default looks are not the best.  We will solve this.  

 * /Dashboard:/ The general dashboard will change to show "Cosmoi-Emacs".
 * /Volatile:/ Mark each time a change occurs.
 * /Beacon:/ Signal the cursor when the view changes.
 * /Rainbow delimiters:/ Color matching parentheses.
 
#+BEGIN_SRC emacs-lisp
  (message "[init] Customization")
  (message "[init] Window customization")

  ;; Startup dashboard.
  (use-package dashboard
      :ensure t
      :diminish dashboard-mode
      :config
         (setq dashboard-banner-logo-title "Cosmoi, Emacs for category theory engineers.")
         (setq dashboard-items '((recents  . 10) (bookmarks . 10)))
         (dashboard-setup-startup-hook)
         (setq dashboard-set-footer nil)
      )

  ;; The package volatile highlights temporarily highlights changes to
  ;; the buffer associated with certain commands that add blocks of text
  ;; at once. An example is that if you paste (yank) a block of text, it
  ;; will be highlighted until you press the next key. This is just a
  ;; small tweak, but gives a nice bit of visual feedback.
  ;; http://pragmaticemacs.com/emacs/volatile-highlights/
  (use-package volatile-highlights
    :ensure t
    :config (volatile-highlights-mode t))

  ;; Beacon signals the position of the cursor when the view changes.  
  (use-package beacon
    :ensure t
    :config (beacon-mode 1))

  ;; Rainbow delimiters colors parentheses with matching and different
  ;; colors. It helps to visually determine the pairing. Rainbow mode
  ;; is disabled for org-mode, because matching parentheses in a big
  ;; org-file is a bit difficult.
  (use-package rainbow-delimiters
    :ensure t
    :config
      (add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
      (add-hook 'LaTeX-mode-hook #'rainbow-delimiters-mode))

  ;; The delimiter character whould be a unicode variant of |.
  ;; (let ((display-table (or standard-display-table (make-display-table))))
  ;;   (set-display-table-slot display-table 'vertical-border (make-glyph-code ?┃))
  ;;   (setq standard-display-table display-table))
#+END_SRC

** Powerline
#+BEGIN_SRC emacs-lisp
  ;; Spaceline provides a really nice-looking bar for Emacs.
  (use-package spaceline
    :ensure t
    :demand t
    :init
      (setq powerline-default-separator 'contour)
    :config
      (require 'spaceline-config)
      (spaceline-emacs-theme)
      (setq-default spaceline-highlight-face-func 'spaceline-highlight-face-evil-state)
      (spaceline-toggle-minor-modes-off))
#+END_SRC

** Fonts
#+BEGIN_SRC emacs-lisp
;; You may notice that I am not declaring a font to be used. Emacs
;; should take the systemwide fontset and just adapt itself to its
;; surroundings.
(setq font-use-system-font t)
#+END_SRC

** Colors
Org-mode comments should be grey instead of red. Code comments inside an org-babel block are still red.

#+BEGIN_SRC emacs-lisp
(set-face-attribute 'org-meta-line nil :foreground "grey60")
#+END_SRC

*** Agda colors for spacemacs-theme
#+BEGIN_SRC emacs-lisp
  ;; Little tweak on agda colors. Original blue was too dark.
  ;; (add-hook 'agda2-mode-hook
  ;;   (lambda ()
  ;;     (set-face-attribute 'agda2-highlight-record-face nil
  ;;       :foreground "light steel blue")))
  ;; (add-hook 'agda2-mode-hook
  ;;   (lambda ()
  ;;     (set-face-attribute 'agda2-highlight-postulate-face nil
  ;;       :foreground "light steel blue")))
  ;; (add-hook 'agda2-mode-hook
  ;;   (lambda ()
  ;;     (set-face-attribute 'agda2-highlight-primitive-face nil
  ;;       :foreground "light steel blue")))
#+END_SRC

